<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OET Practice - SpellRightPro</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  
  <!-- FIREBASE SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>

  <style>
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .btn-primary, .btn-secondary, .btn-danger {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #7b2ff7;
      color: white;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .btn-danger {
      background: #f72585;
      color: white;
    }
    .btn-primary:hover, .btn-secondary:hover, .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .hidden {
      display: none !important;
    }
    .tab-btn.active {
      background: #7b2ff7 !important;
      color: white !important;
    }
    .tab-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav-btn {
      padding: 8px 16px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>

<body data-mode="oet">
  <!-- Header with Dark Mode Toggle -->
  <header>
    <div class="brand">
      <img src="/assets/logo.png" alt="SpellRightPro Logo" />
      <div>
        <h1>SpellRightPro</h1>
        <small>OET Medical English</small>
      </div>
    </div>
    
    <div class="nav-right">
      <button class="nav-btn" onclick="window.location.href='/'">
        <i class="fa fa-home"></i> Home
      </button>
      <button class="nav-btn" id="toggleDark">
        <i class="fa fa-moon"></i> Dark Mode
      </button>
      <button class="btn-premium" onclick="window.location.href='/premium.html'">
        <i class="fa fa-crown"></i> Go Premium
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-card">
    <h2>OET Medical English (Freemium)</h2>
    
    <!-- Practice vs Exam Mode Tabs -->
    <div class="tab-group" style="margin: 20px 0; display: flex; gap: 10px;">
      <button class="tab-btn active" data-test-type="practice" id="tabPractice">
        <i class="fa fa-graduation-cap"></i> Practice (Full List)
      </button>
      <button class="tab-btn" data-test-type="exam" id="tabExam">
        <i class="fa fa-file-alt"></i> Exam (24 Random)
      </button>
    </div>

    <!-- Accent Selection -->
    <div class="accent-select" style="margin: 15px 0; text-align: center;">
      <label for="oetAccent" style="color: white; font-weight: 600; margin-right: 10px;">Accent:</label>
      <select id="oetAccent" style="padding: 8px 12px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
        <option value="en-US">American</option>
        <option value="en-GB">British</option>
        <option value="en-AU">Australian</option>
        <option value="en-CA">Canadian</option>
      </select>
    </div>

    <!-- Custom List Input -->
    <div style="margin: 20px 0;">
      <textarea 
        id="customWords" 
        placeholder="Paste your custom medical word list (optional)..."
        style="width: 100%; min-height: 80px; padding: 10px; border-radius: 8px; border: 1px solid #ccc;"
      ></textarea>
      
      <div style="margin-top: 10px;">
        <input type="file" id="fileInput" accept=".txt,.json" style="display: none;" />
        <button onclick="document.getElementById('fileInput').click()" class="nav-btn">
          <i class="fa fa-upload"></i> Choose File
        </button>
        <span id="fileName" style="margin-left: 10px;">No file chosen</span>
        <button id="useCustomList" class="nav-btn" style="margin-left: 10px;">
          <i class="fa fa-check"></i> Use Custom
        </button>
      </div>
    </div>

    <!-- Ad Container -->
    <div id="ad-container" style="margin: 25px 0; text-align: center; min-height: 90px; display: none;">
      <p style="color: #666; font-size: 0.9em;">Ad placeholder</p>
    </div>

    <!-- Progress and Feedback -->
    <div id="progress" data-role="progress" style="font-weight: 700; margin: 15px 0; font-size: 1.2em; color: #7b2ff7;"></div>
    <div id="feedback" data-role="feedback" style="min-height: 22px; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;"></div>

    <!-- Word Display Area -->
    <div style="margin: 20px 0; text-align: center;">
      <div id="wordDisplay" style="font-size: 2em; font-weight: bold; color: #7b2ff7; min-height: 60px; display: flex; align-items: center; justify-content: center;">
        <span id="wordPlaceholder">‚ùì Word will be spoken</span>
      </div>
      <div id="revealedWord" style="display: none; font-size: 1.5em; color: #4CAF50; margin-top: 10px;"></div>
    </div>

    <!-- Answer Input -->
    <div style="margin: 20px 0;">
      <textarea 
        id="answer" 
        placeholder="Type what you hear..."
        style="width: 100%; min-height: 56px; padding: 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 18px;"
      ></textarea>
    </div>

    <!-- Control Buttons -->
    <div class="button-group" style="margin: 20px 0;">
      <button id="btnStart" class="btn-primary">
        <i class="fa fa-play"></i> Start
      </button>
      <button id="btnSubmit" class="btn-primary">
        <i class="fa fa-check"></i> Submit
      </button>
      <button id="btnSayAgain" class="btn-secondary">
        <i class="fa fa-volume-up"></i> Say Again
      </button>
      <button id="btnPrevious" class="btn-secondary">
        <i class="fa fa-arrow-left"></i> Previous
      </button>
      <button id="btnFlag" class="btn-secondary">
        <i class="fa fa-flag"></i> Flag
      </button>
      <button id="btnEnd" class="btn-danger">
        <i class="fa fa-stop"></i> End
      </button>
    </div>

    <!-- Summary Area -->
    <div id="summaryArea" class="hidden" style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 8px;"></div>
  </main>

  <!-- COOKIE CONSENT BANNER -->
  <div id="cookieConsentBanner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #333; color: white; padding: 15px; text-align: center; z-index: 1000;">
    <p>We use cookies to provide our services and for analytics and ads. 
       <a href="/privacy.html" style="color: #7b2ff7;">Learn more</a>
    </p>
    <button onclick="acceptCookies()" style="background: #7b2ff7; color: white; border: none; padding: 8px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer;">
      Accept
    </button>
    <button onclick="declineCookies()" style="background: #666; color: white; border: none; padding: 8px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer;">
      Decline
    </button>
  </div>

  <!-- ALL JAVASCRIPT EMBEDDED - NO EXTERNAL FILES NEEDED -->
  <script>
  // ==================== FIREBASE CONFIG ====================
  const firebaseConfig = {
    apiKey: "AIzaSyC4R6ANRkm6H3v8v0Xk6x0qYJqY6wZ8abc",
    authDomain: "spellrightpro.firebaseapp.com",
    projectId: "spellrightpro",
    storageBucket: "spellrightpro.appspot.com",
    messagingSenderId: "123456789012",
    appId: "1:123456789012:web:abcdef1234567890",
    measurementId: "G-ABCDEF1234"
  };

  // Initialize Firebase
  window.initFirebase = function() {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      
      // Only initialize analytics if cookies accepted
      const consent = localStorage.getItem('cookieConsent');
      if (consent === 'true') {
        firebase.analytics();
        console.log('üìä Firebase Analytics initialized');
      }
    }
    return firebase;
  };

  // ==================== COOKIE CONSENT ====================
  function showCookieBanner() {
    const consent = localStorage.getItem('cookieConsent');
    if (consent === null) {
      document.getElementById('cookieConsentBanner').style.display = 'block';
    } else if (consent === 'true') {
      initializeAnalytics();
    }
  }

  function acceptCookies() {
    localStorage.setItem('cookieConsent', 'true');
    document.getElementById('cookieConsentBanner').style.display = 'none';
    initializeAnalytics();
    console.log('‚úÖ Cookies accepted - Analytics enabled');
  }

  function declineCookies() {
    localStorage.setItem('cookieConsent', 'false');
    document.getElementById('cookieConsentBanner').style.display = 'none';
    console.log('üîï Cookies declined - Analytics disabled');
  }

  function initializeAnalytics() {
    if (typeof window.initFirebase === 'function') {
      setTimeout(() => {
        window.initFirebase();
      }, 500);
    }
  }

  // ==================== TIER MANAGER ====================
  window.tierManager = {
    init: function() {
      console.log('üéØ Tier Manager Initialized for OET');
      
      // Check user tier and apply restrictions
      this.applyFreemiumLimitations();
      
      // Show/hide premium features
      this.togglePremiumFeatures();
      
      // Initialize ads if applicable
      this.initializeAds();
    },
    
    applyFreemiumLimitations: function() {
      // Freemium limitations for OET
      const maxCustomWords = 50; // Freemium limit
      const maxSessionWords = 100; // Freemium limit
      
      console.log(`üéØ Freemium mode: Max ${maxCustomWords} custom words, ${maxSessionWords} words per session`);
      
      // Apply word count limitations
      this.limitCustomWords(maxCustomWords);
    },
    
    limitCustomWords: function(maxWords) {
      const customBox = document.getElementById('customWords');
      if (customBox) {
        customBox.addEventListener('input', function() {
          const words = this.value.split(/[\n,]+/).filter(w => w.trim());
          if (words.length > maxWords) {
            const limitedWords = words.slice(0, maxWords);
            this.value = limitedWords.join('\n');
            document.getElementById('feedback').textContent = 
              `Freemium limit: Using first ${maxWords} words only`;
            document.getElementById('feedback').style.color = '#f72585';
          }
        });
      }
    },
    
    togglePremiumFeatures: function() {
      // Hide premium-only features in freemium
      const premiumFeatures = document.querySelectorAll('.premium-only');
      premiumFeatures.forEach(feature => {
        feature.style.display = 'none';
      });
      
      // Add upgrade prompts
      this.addUpgradePrompts();
    },
    
    addUpgradePrompts: function() {
      // Add upgrade message after summary
      const summaryArea = document.getElementById('summaryArea');
      if (summaryArea) {
        const upgradeHTML = `
          <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #7b2ff7, #f72585); border-radius: 10px; color: white;">
            <h4 style="margin: 0 0 10px 0;">üöÄ Want More Features?</h4>
            <p style="margin: 0 0 15px 0; font-size: 0.9em;">
              Upgrade to Premium for:<br>
              ‚Ä¢ Unlimited custom words<br>
              ‚Ä¢ No ads<br>
              ‚Ä¢ Progress tracking<br>
              ‚Ä¢ Advanced analytics<br>
              ‚Ä¢ All accents unlocked
            </p>
            <button onclick="window.location.href='/premium.html'" 
              style="background: white; color: #7b2ff7; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">
              <i class="fa fa-crown"></i> Upgrade Now
            </button>
          </div>
        `;
        
        // Store the HTML to add later
        window.premiumUpgradeHTML = upgradeHTML;
      }
    },
    
    initializeAds: function() {
      // Simple ad simulation for freemium
      const adContainer = document.getElementById('ad-container');
      if (adContainer) {
        setTimeout(() => {
          adContainer.style.display = 'block';
          adContainer.innerHTML = `
            <div style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px;">
              <p style="color: #666; font-size: 0.9em; margin: 0;">
                üî• <strong>Upgrade to Premium</strong> for an ad-free experience!
              </p>
              <button onclick="window.location.href='/premium.html'" 
                style="background: #7b2ff7; color: white; border: none; padding: 5px 15px; border-radius: 4px; font-size: 0.8em; margin-top: 5px; cursor: pointer;">
                Remove Ads
              </button>
            </div>
          `;
        }, 3000);
      }
    }
  };

  // ==================== OET MAIN APPLICATION ====================
  (function() {
    console.log('Starting OET Spelling Test...');
    
    // UI Elements
    const elements = {
      answer: document.getElementById('answer'),
      submit: document.getElementById('btnSubmit'),
      start: document.getElementById('btnStart'),
      say: document.getElementById('btnSayAgain'),
      previous: document.getElementById('btnPrevious'),
      flag: document.getElementById('btnFlag'),
      end: document.getElementById('btnEnd'),
      progress: document.getElementById('progress'),
      feedback: document.getElementById('feedback'),
      summaryArea: document.getElementById('summaryArea'),
      tabExam: document.getElementById('tabExam'),
      tabPractice: document.getElementById('tabPractice'),
      accentSelect: document.getElementById('oetAccent'),
      customBox: document.getElementById('customWords'),
      useCustom: document.getElementById('useCustomList'),
      wordDisplay: document.getElementById('wordPlaceholder'),
      revealedWord: document.getElementById('revealedWord')
    };
    
    // Full OET Medical Words List (100+ words)
    const OET_WORDS = [
      'abdomen', 'anemia', 'antibiotic', 'artery', 'asthma', 'biopsy', 'catheter', 
      'diagnosis', 'embolism', 'fracture', 'gastroenterology', 'hemorrhage', 'intravenous', 
      'jaundice', 'kidney', 'laceration', 'membrane', 'neurology', 'obstetrics', 'pulmonary',
      // Additional medical terms
      'abdominal', 'acute', 'allergy', 'antibody', 'antigen', 'arthritis', 'bacteria',
      'benign', 'bronchitis', 'carcinoma', 'cardiology', 'cerebral', 'chronic',
      'clinical', 'complication', 'congenital', 'contagious', 'contusion', 'cortex',
      'dementia', 'dermatology', 'diabetes', 'diagnostic', 'dialysis', 'diarrhea',
      'dislocation', 'dysfunction', 'dyspnea', 'eczema', 'edema', 'encephalitis',
      'endocarditis', 'endoscopy', 'epidemic', 'epilepsy', 'erosion', 'excision',
      'febrile', 'fistula', 'gastritis', 'genetics', 'geriatrics', 'gynecology',
      'hematology', 'hepatitis', 'hernia', 'hormone', 'hypertension', 'hypotension',
      'immunity', 'incision', 'infarction', 'inflammation', 'influenza', 'injection',
      'ischemia', 'lesion', 'leukemia', 'ligament', 'malignant', 'meningitis',
      'metabolism', 'metastasis', 'microbiology', 'migraine', 'morbidity', 'mortality',
      'myocardial', 'nausea', 'neonatal', 'nephrology', 'neural', 'neuropathy',
      'nutrition', 'obesity', 'oncology', 'ophthalmology', 'orthopedics', 'osteoporosis',
      'otolaryngology', 'palliative', 'pancreas', 'paralysis', 'pathology', 'pediatrics',
      'pharmacology', 'pharynx', 'physiology', 'pneumonia', 'prognosis', 'prophylaxis',
      'psychiatry', 'pulmonary', 'radiology', 'rehabilitation', 'remission', 'resection',
      'respiratory', 'rheumatology', 'sarcoma', 'sepsis', 'symptom', 'syndrome',
      'therapy', 'thrombosis', 'trachea', 'trauma', 'tumor', 'ulcer', 'urinary',
      'vaccine', 'vascular', 'ventricle', 'vertebra', 'virology', 'virus', 'vital'
    ];
    
    // Remove duplicates
    const UNIQUE_OET_WORDS = [...new Set(OET_WORDS)];
    
    // App State
    const state = {
      words: [],
      currentIndex: 0,
      correct: [],
      incorrect: [],
      flags: new Set(),
      isActive: false,
      isExam: false,
      history: [],
      currentWord: ''
    };
    
    // Update progress display
    function updateProgress() {
      if (elements.progress) {
        elements.progress.textContent = `Word ${state.currentIndex + 1} of ${state.words.length}`;
      }
    }
    
    // Update feedback
    function updateFeedback(message, isError = false) {
      if (elements.feedback) {
        elements.feedback.textContent = message;
        elements.feedback.style.color = isError ? '#f72585' : '#ffffff';
      }
      console.log(message);
    }
    
    // Show word display (hidden for spelling test)
    function updateWordDisplay(reveal = false) {
      if (!state.isActive || state.currentIndex >= state.words.length) return;
      
      const word = state.words[state.currentIndex];
      state.currentWord = word;
      
      if (elements.wordDisplay) {
        if (reveal) {
          elements.wordDisplay.innerHTML = `<span style="color: #4CAF50;">${word}</span>`;
          if (elements.revealedWord) {
            elements.revealedWord.textContent = word;
            elements.revealedWord.style.display = 'block';
          }
        } else {
          elements.wordDisplay.innerHTML = '<span style="color: #666;">üîà Listen carefully...</span>';
          if (elements.revealedWord) {
            elements.revealedWord.style.display = 'none';
          }
        }
      }
    }
    
    // Speak word with selected accent
    function speakWord(word) {
      if (!window.speechSynthesis) {
        updateFeedback('Speech synthesis not supported', true);
        return;
      }
      
      try {
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.rate = 0.85;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        const accent = elements.accentSelect ? elements.accentSelect.value : 'en-US';
        utterance.lang = accent;
        
        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
          let voice = voices.find(v => v.lang === accent);
          if (!voice) {
            voice = voices.find(v => v.lang.includes('en')) || voices[0];
          }
          utterance.voice = voice;
        }
        
        utterance.onend = () => {
          console.log('Finished speaking:', word);
        };
        
        utterance.onerror = (e) => {
          console.error('Speech error:', e);
          updateFeedback('Error speaking word', true);
        };
        
        speechSynthesis.speak(utterance);
        updateFeedback(`Word spoken with ${getAccentName(accent)} accent`);
        
      } catch (error) {
        console.error('Speech error:', error);
        updateFeedback('Could not speak word', true);
      }
    }
    
    // Get accent display name
    function getAccentName(accentCode) {
      const accentMap = {
        'en-US': 'American',
        'en-GB': 'British', 
        'en-AU': 'Australian',
        'en-CA': 'Canadian'
      };
      return accentMap[accentCode] || accentCode;
    }
    
    // Speak current word
    function speakCurrentWord() {
      if (!state.isActive || state.currentIndex >= state.words.length) return;
      const word = state.words[state.currentIndex];
      if (word) {
        updateWordDisplay(false);
        speakWord(word);
      }
    }
    
    // Go to previous word
    function goToPreviousWord() {
      if (!state.isActive) {
        updateFeedback('Start a session first', true);
        return;
      }
      
      if (state.currentIndex <= 0) {
        updateFeedback('Already at the first word', true);
        return;
      }
      
      state.history.push(state.currentIndex);
      if (state.history.length > 10) state.history.shift();
      
      state.currentIndex--;
      
      if (elements.answer) elements.answer.value = '';
      if (elements.revealedWord) elements.revealedWord.style.display = 'none';
      
      updateProgress();
      updateWordDisplay(false);
      speakCurrentWord();
      updateFeedback(`‚Üê Went back to word ${state.currentIndex + 1}`);
      
      saveProgress();
    }
    
    // Check answer
    function checkAnswer() {
      if (!state.isActive) {
        updateFeedback('Start a session first', true);
        return;
      }
      
      const word = state.words[state.currentIndex];
      const answer = elements.answer ? elements.answer.value.trim() : '';
      
      if (!answer) {
        updateFeedback('Please type what you heard', true);
        return;
      }
      
      const normalizedWord = word.toLowerCase().trim();
      const normalizedAnswer = answer.toLowerCase().trim();
      
      updateWordDisplay(true);
      
      if (normalizedAnswer === normalizedWord) {
        state.correct.push(word);
        updateFeedback(`‚úÖ Correct! You spelled "${word}" correctly.`);
      } else {
        state.incorrect.push({ 
          word: word, 
          answer: answer,
          yourSpelling: answer,
          correctSpelling: word
        });
        updateFeedback(`‚ùå Incorrect. You wrote "${answer}", but correct is "${word}"`);
      }
      
      if (elements.answer) elements.answer.value = '';
      
      state.currentIndex++;
      
      if (state.currentIndex < state.words.length) {
        updateProgress();
        setTimeout(() => {
          updateWordDisplay(false);
          setTimeout(speakCurrentWord, 500);
        }, 2000);
      } else {
        setTimeout(endSession, 1500);
      }
      
      saveProgress();
    }
    
    // Start session
    function startSession() {
      const customText = elements.customBox ? elements.customBox.value.trim() : '';
      
      if (customText) {
        const words = customText.split(/[\n,]+/).map(w => w.trim()).filter(w => w);
        // Apply freemium limit
        const limitedWords = words.slice(0, 50);
        state.words = limitedWords;
        if (words.length > 50) {
          updateFeedback(`Freemium: Using first 50 of ${words.length} words`);
        } else {
          updateFeedback(`Using custom list: ${words.length} words`);
        }
      } else {
        if (state.isExam) {
          const shuffled = [...UNIQUE_OET_WORDS].sort(() => Math.random() - 0.5);
          state.words = shuffled.slice(0, 24);
          updateFeedback(`‚úÖ Exam mode: ${state.words.length} random words`);
        } else {
          state.words = [...UNIQUE_OET_WORDS].slice(0, 100); // Freemium limit
          updateFeedback(`Practice mode: ${state.words.length} words (freemium limit)`);
        }
      }
      
      if (state.words.length === 0) {
        updateFeedback('No words available', true);
        return;
      }
      
      state.currentIndex = 0;
      state.correct = [];
      state.incorrect = [];
      state.flags.clear();
      state.history = [];
      state.isActive = true;
      
      if (elements.summaryArea) {
        elements.summaryArea.style.display = 'none';
        elements.summaryArea.classList.add('hidden');
      }
      if (elements.revealedWord) {
        elements.revealedWord.style.display = 'none';
      }
      
      updateProgress();
      updateWordDisplay(false);
      updateFeedback('Session started! Listen carefully...');
      
      setTimeout(() => {
        speakCurrentWord();
      }, 1000);
      
      saveProgress();
    }
    
    // End session and show summary
    function endSession() {
      state.isActive = false;
      speechSynthesis.cancel();
      
      const total = state.words.length;
      const correctCount = state.correct.length;
      const incorrectWords = state.incorrect;
      const flaggedWords = Array.from(state.flags);
      
      let summaryHTML = `
        <div style="background: rgba(0,0,0,0.1); padding: 20px; border-radius: 10px;">
          <h3 style="margin-top: 0; color: #7b2ff7;">Session Complete! üéâ</h3>
          <p style="font-size: 1.2em; font-weight: bold; color: #7b2ff7;">
            Score: ${correctCount}/${total} correct (${Math.round((correctCount/total)*100)}%)
          </p>
      `;
      
      if (state.incorrect.length > 0) {
        summaryHTML += `
          <div style="margin: 20px 0;">
            <h4 style="color: #f72585;">‚ùå Missed Words (${state.incorrect.length})</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
        `;
        
        state.incorrect.forEach(item => {
          summaryHTML += `
            <div style="background: rgba(247, 37, 133, 0.1); padding: 10px; border-radius: 5px;">
              <strong style="color: #f72585;">${item.correctSpelling}</strong><br>
              <small>You spelled: <span style="color: #666;">"${item.yourSpelling}"</span></small>
            </div>
          `;
        });
        
        summaryHTML += `</div></div>`;
      }
      
      if (flaggedWords.length > 0) {
        summaryHTML += `
          <div style="margin: 20px 0;">
            <h4 style="color: #ffd166;">üö© Flagged Words (${flaggedWords.length})</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
        `;
        
        flaggedWords.forEach(word => {
          summaryHTML += `
            <div style="background: rgba(255, 209, 102, 0.1); padding: 10px; border-radius: 5px;">
              ${word}
            </div>
          `;
        });
        
        summaryHTML += `</div></div>`;
      }
      
      summaryHTML += `
        <div style="margin: 20px 0; padding: 15px; background: rgba(123, 47, 247, 0.1); border-radius: 8px;">
          <h4 style="color: #7b2ff7;">Continue Practicing</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      `;
      
      if (state.incorrect.length > 0) {
        summaryHTML += `
          <button onclick="practiceIncorrect()" class="btn-secondary" style="background: #f72585;">
            <i class="fa fa-redo"></i> Practice Missed (${state.incorrect.length})
          </button>
        `;
      }
      
      if (flaggedWords.length > 0) {
        summaryHTML += `
          <button onclick="practiceFlagged()" class="btn-secondary" style="background: #ffd166; color: #333;">
            <i class="fa fa-flag"></i> Practice Flagged (${flaggedWords.length})
          </button>
        `;
      }
      
      summaryHTML += `
            <button onclick="restartSession()" class="btn-primary">
              <i class="fa fa-play-circle"></i> New Session
            </button>
          </div>
          <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
            Want to practice specific words? Enter word numbers (e.g., 1,5,10): 
            <input type="text" id="specificWords" placeholder="1,5,10" style="width: 100px; padding: 5px;">
            <button onclick="practiceSpecificWords()" class="nav-btn" style="padding: 5px 10px;">Practice</button>
          </p>
        </div>
      `;
      
      // Add premium upgrade prompt
      summaryHTML += `
        <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #7b2ff7, #f72585); border-radius: 10px; color: white;">
          <h4 style="margin: 0 0 10px 0;">üöÄ Want More Features?</h4>
          <p style="margin: 0 0 15px 0; font-size: 0.9em;">
            Upgrade to Premium for:<br>
            ‚Ä¢ Unlimited custom words<br>
            ‚Ä¢ No ads<br>
            ‚Ä¢ Progress tracking<br>
            ‚Ä¢ Advanced analytics<br>
            ‚Ä¢ All accents unlocked
          </p>
          <button onclick="window.location.href='/premium.html'" 
            style="background: white; color: #7b2ff7; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">
            <i class="fa fa-crown"></i> Upgrade Now
          </button>
        </div>
      `;
      
      summaryHTML += `</div>`;
      
      if (elements.summaryArea) {
        elements.summaryArea.innerHTML = summaryHTML;
        elements.summaryArea.style.display = 'block';
        elements.summaryArea.classList.remove('hidden');
      }
      
      updateFeedback('Session completed! Check your results below.');
      localStorage.removeItem('oet_progress');
    }
    
    // Save progress to localStorage
    function saveProgress() {
      const progress = {
        words: state.words,
        currentIndex: state.currentIndex,
        correct: state.correct,
        incorrect: state.incorrect,
        flags: Array.from(state.flags),
        isExam: state.isExam,
        timestamp: Date.now()
      };
      localStorage.setItem('oet_progress', JSON.stringify(progress));
    }
    
    // Load progress from localStorage
    function loadProgress() {
      try {
        const saved = localStorage.getItem('oet_progress');
        if (!saved) return false;
        
        const progress = JSON.parse(saved);
        const hoursOld = (Date.now() - progress.timestamp) / (1000 * 60 * 60);
        
        if (hoursOld > 24) {
          localStorage.removeItem('oet_progress');
          return false;
        }
        
        state.words = progress.words || [];
        state.currentIndex = progress.currentIndex || 0;
        state.correct = progress.correct || [];
        state.incorrect = progress.incorrect || [];
        state.flags = new Set(progress.flags || []);
        state.isExam = progress.isExam || false;
        
        if (state.words.length > 0 && state.currentIndex < state.words.length) {
          const resume = confirm(`You have an incomplete session.\nResume from word ${state.currentIndex + 1} of ${state.words.length}?`);
          if (resume) {
            state.isActive = true;
            updateProgress();
            updateWordDisplay(false);
            speakCurrentWord();
            updateFeedback(`Resumed from word ${state.currentIndex + 1}`);
            return true;
          }
        }
      } catch (error) {
        console.error('Error loading progress:', error);
      }
      return false;
    }
    
    // Practice only incorrect words
    function practiceIncorrect() {
      const incorrectWords = state.incorrect.map(item => item.correctSpelling);
      if (incorrectWords.length === 0) {
        updateFeedback('No missed words to practice', true);
        return;
      }
      
      state.words = [...new Set(incorrectWords)];
      state.currentIndex = 0;
      state.correct = [];
      state.incorrect = [];
      state.flags.clear();
      state.isActive = true;
      
      if (elements.summaryArea) {
        elements.summaryArea.style.display = 'none';
        elements.summaryArea.classList.add('hidden');
      }
      if (elements.revealedWord) {
        elements.revealedWord.style.display = 'none';
      }
      
      updateProgress();
      updateWordDisplay(false);
      updateFeedback(`Practicing ${state.words.length} missed words`);
      
      setTimeout(() => {
        speakCurrentWord();
      }, 1000);
    }
    
    // Practice only flagged words
    function practiceFlagged() {
      const flaggedWords = Array.from(state.flags);
      if (flaggedWords.length === 0) {
        updateFeedback('No flagged words to practice', true);
        return;
      }
      
      state.words = flaggedWords;
      state.currentIndex = 0;
      state.correct = [];
      state.incorrect = [];
      state.flags.clear();
      state.isActive = true;
      
      if (elements.summaryArea) {
        elements.summaryArea.style.display = 'none';
        elements.summaryArea.classList.add('hidden');
      }
      if (elements.revealedWord) {
        elements.revealedWord.style.display = 'none';
      }
      
      updateProgress();
      updateWordDisplay(false);
      updateFeedback(`Practicing ${flaggedWords.length} flagged words`);
      
      setTimeout(() => {
        speakCurrentWord();
      }, 1000);
    }
    
    // Practice specific words by number
    function practiceSpecificWords() {
      const input = document.getElementById('specificWords');
      if (!input) return;
      
      const numbersText = input.value.trim();
      if (!numbersText) {
        updateFeedback('Enter word numbers first', true);
        return;
      }
      
      const numbers = numbersText.split(/[,\s]+/).map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= UNIQUE_OET_WORDS.length);
      
      if (numbers.length === 0) {
        updateFeedback('Enter valid word numbers (1-' + UNIQUE_OET_WORDS.length + ')', true);
        return;
      }
      
      const selectedWords = numbers.map(n => UNIQUE_OET_WORDS[n - 1]).filter(w => w);
      
      state.words = selectedWords.slice(0, 50); // Freemium limit
      state.currentIndex = 0;
      state.correct = [];
      state.incorrect = [];
      state.flags.clear();
      state.isActive = true;
      
      if (elements.summaryArea) {
        elements.summaryArea.style.display = 'none';
        elements.summaryArea.classList.add('hidden');
      }
      if (elements.revealedWord) {
        elements.revealedWord.style.display = 'none';
      }
      
      updateProgress();
      updateWordDisplay(false);
      updateFeedback(`Practicing ${selectedWords.length} selected words`);
      
      setTimeout(() => {
        speakCurrentWord();
      }, 1000);
    }
    
    // Restart session
    function restartSession() {
      if (elements.summaryArea) {
        elements.summaryArea.style.display = 'none';
        elements.summaryArea.classList.add('hidden');
      }
      
      if (elements.answer) {
        elements.answer.value = '';
      }
      
      if (elements.revealedWord) {
        elements.revealedWord.style.display = 'none';
      }
      
      updateWordDisplay(false);
      updateFeedback('Ready to start new session');
      updateProgress();
      
      localStorage.removeItem('oet_progress');
    }
    
    // Toggle flag for current word
    function toggleFlag() {
      if (!state.isActive || state.currentIndex >= state.words.length) {
        updateFeedback('No active word to flag', true);
        return;
      }
      
      const word = state.words[state.currentIndex];
      if (state.flags.has(word)) {
        state.flags.delete(word);
        updateFeedback(`üö© Removed flag from "${word}"`);
      } else {
        state.flags.add(word);
        updateFeedback(`üö© Flagged "${word}" for review`);
      }
      
      saveProgress();
    }
    
    // Set up event listeners
    function setupEventListeners() {
      if (elements.start) elements.start.addEventListener('click', startSession);
      if (elements.submit) elements.submit.addEventListener('click', checkAnswer);
      if (elements.say) elements.say.addEventListener('click', speakCurrentWord);
      if (elements.previous) elements.previous.addEventListener('click', goToPreviousWord);
      if (elements.flag) elements.flag.addEventListener('click', toggleFlag);
      if (elements.end) elements.end.addEventListener('click', endSession);
      
      if (elements.answer) {
        elements.answer.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            checkAnswer();
          }
        });
      }
      
      if (elements.tabExam) {
        elements.tabExam.addEventListener('click', () => {
          state.isExam = true;
          elements.tabExam.classList.add('active');
          if (elements.tabPractice) elements.tabPractice.classList.remove('active');
          updateFeedback('Exam mode selected - 24 random words');
        });
      }
      
      if (elements.tabPractice) {
        elements.tabPractice.addEventListener('click', () => {
          state.isExam = false;
          elements.tabPractice.classList.add('active');
          if (elements.tabExam) elements.tabExam.classList.remove('active');
          updateFeedback('Practice mode selected - all words');
        });
      }
      
      if (elements.useCustom) {
        elements.useCustom.addEventListener('click', () => {
          const customText = elements.customBox ? elements.customBox.value.trim() : '';
          if (!customText) {
            updateFeedback('Please enter words in the custom box first', true);
            return;
          }
          const words = customText.split(/[\n,]+/).map(w => w.trim()).filter(w => w);
          state.words = words.slice(0, 50); // Freemium limit
          updateFeedback(`Custom list loaded: ${Math.min(words.length, 50)} words (freemium limit)`);
        });
      }
      
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            document.getElementById('fileName').textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
              if (elements.customBox) {
                elements.customBox.value = e.target.result;
                updateFeedback(`File loaded: ${file.name}`);
              }
            };
            reader.readAsText(file);
          }
        });
      }
    }
    
    // Initialize the app
    function initialize() {
      console.log('Initializing OET Spelling Test...');
      
      setupEventListeners();
      loadProgress();
      
      // Initialize dark mode toggle
      const darkModeToggle = document.getElementById('toggleDark');
      if (darkModeToggle) {
        darkModeToggle.addEventListener('click', () => {
          document.body.classList.toggle('dark-mode');
          const icon = darkModeToggle.querySelector('i');
          if (icon) {
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
          }
          localStorage.setItem('dark', document.body.classList.contains('dark-mode'));
        });
        
        const savedDarkMode = localStorage.getItem('dark') === 'true';
        if (savedDarkMode) {
          document.body.classList.add('dark-mode');
          const icon = darkModeToggle.querySelector('i');
          if (icon) icon.className = 'fa fa-sun';
        }
      }
      
      // Expose functions globally
      window.practiceIncorrect = practiceIncorrect;
      window.practiceFlagged = practiceFlagged;
      window.restartSession = restartSession;
      window.practiceSpecificWords = practiceSpecificWords;
      
      // Initialize tier manager
      if (window.tierManager) {
        window.tierManager.init();
      }
      
      // Show cookie banner after delay
      setTimeout(() => {
        showCookieBanner();
      }, 1500);
      
      updateFeedback('Ready! Click "Start" to begin your OET spelling practice.');
      console.log('‚úÖ OET Spelling Test initialized successfully');
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
    
  })();
  </script>

  <!-- File input handler -->
  <script>
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('fileName').textContent = file.name;
      }
    });

    // Tab styling
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
      });
    });
  </script>

  <!-- Legal Footer -->
  <footer style="text-align: center; margin-top: 40px; padding: 20px; color: #666; border-top: 1px solid rgba(255,255,255,0.1);">
    <p>
        <a href="/privacy.html" style="color: #7b2ff7; text-decoration: none;">Privacy Policy</a> 
        ‚Ä¢ 
        <a href="/terms.html" style="color: #7b2ff7; text-decoration: none;">Terms of Service</a>
        ‚Ä¢ 
        <a href="/refund-policy.html" style="color: #7b2ff7; text-decoration: none;">Refund Policy</a>
        ‚Ä¢ 
        <a href="/contact.html" style="color: #7b2ff7; text-decoration: none;">Contact</a>
    </p>
    <p style="margin-top: 10px; font-size: 0.9em;">&copy; 2025 SpellRightPro. All rights reserved.</p>
  </footer>
</body>
</html>
