<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>School Practice - SpellRightPro</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>

    <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-H09MF13297"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-H09MF13297');
    
    // Function to track premium clicks
    function trackPremiumClick(source, plan) {
      gtag('event', 'premium_click', {
        event_category: 'premium_conversion',
        event_label: source,
        value: plan === 'complete' ? 8.99 : plan === 'school' ? 4.99 : 14.99
      });
    }
    
    // Function to track plan view
    function trackPlanView(plan) {
      gtag('event', 'view_item', {
        items: [{
          item_id: plan,
          item_name: 'SpellRightPro ' + plan,
          item_category: 'premium_plans'
        }]
      });
    }
  </script>
</head>
<body data-mode="school">
  <!-- Header with Dark Mode Toggle -->
  <header>
    <div class="brand">
      <img src="/assets/logo.png" alt="SpellRightPro Logo" />
      <div>
        <h1>SpellRightPro</h1>
        <small>School Practice</small>
      </div>
    </div>
    
    <div class="nav-right">
      <button class="nav-btn" onclick="window.location.href='/'">
        <i class="fa fa-home"></i> Home
      </button>
      <button class="nav-btn" id="toggleDark">
        <i class="fa fa-moon"></i> Dark Mode
      </button>
      <button class="btn-premium" onclick="window.location.href='/premium.html'">
        <i class="fa fa-crown"></i> Go Premium
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-card">
    <h2>SpellRightPro School</h2>
    <h3>School Practice (Freemium)</h3>
    <p>Type what you hear. Answer box clears as soon as you're marked. Auto-advance is on.</p>

    <!-- Custom List Input -->
    <div style="margin: 20px 0;">
      <textarea 
        id="customWords" 
        placeholder="Paste your custom list (optional)..."
        style="width: 100%; min-height: 80px; padding: 10px; border-radius: 8px; border: 1px solid #ccc;"
      ></textarea>
      
      <div style="margin-top: 10px;">
        <input type="file" id="fileInput" accept=".txt,.json" style="display: none;" />
        <button onclick="document.getElementById('fileInput').click()" class="nav-btn">
          <i class="fa fa-upload"></i> Choose File
        </button>
        <span id="fileName" style="margin-left: 10px;">No file chosen</span>
        <button id="useCustomList" class="nav-btn" style="margin-left: 10px;">
          <i class="fa fa-check"></i> Use Custom
        </button>
      </div>
    </div>

    <!-- Ad Container -->
    <div id="ad-container" style="margin: 25px 0; text-align: center; min-height: 90px; display: none;">
      <p style="color: #666; font-size: 0.9em;">Ad placeholder - will show ads after AdSense approval</p>
    </div>

    <!-- Progress and Feedback -->
    <div id="progress" data-role="progress" style="font-weight: 700; margin: 15px 0;"></div>
    <div id="feedback" data-role="feedback" style="min-height: 22px; margin: 10px 0;"></div>

    <!-- Answer Input -->
    <div style="margin: 20px 0;">
      <textarea 
        id="answer" 
        placeholder="Type the spelling here..."
        style="width: 100%; min-height: 56px; padding: 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 18px;"
      ></textarea>
    </div>

    <!-- Control Buttons -->
    <div class="button-group" style="margin: 20px 0;">
      <button id="btnStart" class="btn-primary">
        <i class="fa fa-play"></i> Start
      </button>
      <button id="btnSubmit" class="btn-primary">
        <i class="fa fa-check"></i> Submit
      </button>
      <button id="btnSayAgain" class="btn-secondary">
        <i class="fa fa-volume-up"></i> Say Again
      </button>
      <button id="btnFlag" class="btn-secondary">
        <i class="fa fa-flag"></i> Flag
      </button>
      <button id="btnEnd" class="btn-danger">
        <i class="fa fa-stop"></i> End
      </button>
    </div>

    <!-- Summary Area -->
    <div class="summary-area hidden" style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 8px;"></div>
  </main>

  <!-- COOKIE CONSENT BANNER -->
  <div id="cookieConsentBanner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #333; color: white; padding: 15px; text-align: center; z-index: 1000;">
    <p>We use cookies to provide our services and for analytics and ads. 
       <a href="/privacy.html" style="color: #7b2ff7;">Learn more</a>
    </p>
    <button onclick="acceptCookies()" style="background: #7b2ff7; color: white; border: none; padding: 8px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer;">
        Accept
    </button>
    <button onclick="declineCookies()" style="background: #666; color: white; border: none; padding: 8px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer;">
        Decline
    </button>
  </div>

  <!-- ALL JAVASCRIPT EMBEDDED -->
  <script>
  // ==================== FIREBASE CONFIG ====================
const firebaseConfig = {
  apiKey: "AIzaSyCZ-rAPnRgVjSRFOFvbiQlowE6A3RVvwWo",
  authDomain: "spellrightpro-firebase.firebaseapp.com",
  projectId: "spellrightpro-firebase",
  storageBucket: "spellrightpro-firebase.firebasestorage.app",
  messagingSenderId: "798456641137",
  appId: "1:798456641137:web:5c6d79db5bf49d04928dd0",
  measurementId: "G-H09MF13297"
};

  // Initialize Firebase
  window.initFirebase = function() {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      
      const consent = localStorage.getItem('cookieConsent');
      if (consent === 'true') {
        firebase.analytics();
        console.log('üìä Firebase Analytics initialized');
      }
    }
    return firebase;
  };

  // ==================== COOKIE CONSENT ====================
  function showCookieBanner() {
    const consent = localStorage.getItem('cookieConsent');
    if (consent === null) {
      document.getElementById('cookieConsentBanner').style.display = 'block';
    } else if (consent === 'true') {
      initializeAnalytics();
    }
  }

  function acceptCookies() {
    localStorage.setItem('cookieConsent', 'true');
    document.getElementById('cookieConsentBanner').style.display = 'none';
    initializeAnalytics();
    console.log('‚úÖ Cookies accepted - Analytics enabled');
  }

  function declineCookies() {
    localStorage.setItem('cookieConsent', 'false');
    document.getElementById('cookieConsentBanner').style.display = 'none';
    console.log('üîï Cookies declined - Analytics disabled');
  }

  function initializeAnalytics() {
    if (typeof window.initFirebase === 'function') {
      setTimeout(() => {
        window.initFirebase();
      }, 500);
    }
  }

  // ==================== TIER MANAGER ====================
  window.tierManager = {
    init: function() {
      console.log('üéØ Tier Manager Initialized for School');
      this.applyFreemiumLimitations();
      this.togglePremiumFeatures();
      this.initializeAds();
    },
    
    applyFreemiumLimitations: function() {
      const maxCustomWords = 30; // Lower limit for school freemium
      const maxSessionWords = 50;
      
      console.log(`üéØ School Freemium: Max ${maxCustomWords} custom words, ${maxSessionWords} words per session`);
      
      this.limitCustomWords(maxCustomWords);
    },
    
    limitCustomWords: function(maxWords) {
      const customBox = document.getElementById('customWords');
      if (customBox) {
        customBox.addEventListener('input', function() {
          const words = this.value.split(/[\n,]+/).filter(w => w.trim());
          if (words.length > maxWords) {
            const limitedWords = words.slice(0, maxWords);
            this.value = limitedWords.join('\n');
            document.getElementById('feedback').textContent = 
              `School Freemium limit: Using first ${maxWords} words only`;
            document.getElementById('feedback').style.color = '#f72585';
          }
        });
      }
    },
    
    togglePremiumFeatures: function() {
      const premiumFeatures = document.querySelectorAll('.premium-only');
      premiumFeatures.forEach(feature => {
        feature.style.display = 'none';
      });
      
      this.addUpgradePrompts();
    },
    
    addUpgradePrompts: function() {
      const summaryArea = document.querySelector('.summary-area');
      if (summaryArea) {
        const upgradeHTML = `
          <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #7b2ff7, #f72585); border-radius: 10px; color: white;">
            <h4 style="margin: 0 0 10px 0;">üè´ Unlock School Premium!</h4>
            <p style="margin: 0 0 15px 0; font-size: 0.9em;">
              Perfect for students and teachers:<br>
              ‚Ä¢ Unlimited word lists<br>
              ‚Ä¢ Create and save custom lists<br>
              ‚Ä¢ Track student progress<br>
              ‚Ä¢ Export results<br>
              ‚Ä¢ No ads
            </p>
            <button onclick="window.location.href='/premium.html'" 
              style="background: white; color: #7b2ff7; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">
              <i class="fa fa-crown"></i> Get School Premium
            </button>
          </div>
        `;
        
        window.schoolPremiumUpgradeHTML = upgradeHTML;
      }
    },
    
    initializeAds: function() {
      const adContainer = document.getElementById('ad-container');
      if (adContainer) {
        setTimeout(() => {
          adContainer.style.display = 'block';
          adContainer.innerHTML = `
            <div style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px;">
              <p style="color: #666; font-size: 0.9em; margin: 0;">
                üè´ <strong>School Premium</strong> - Perfect for classrooms!
              </p>
              <button onclick="window.location.href='/premium.html'" 
                style="background: #7b2ff7; color: white; border: none; padding: 5px 15px; border-radius: 4px; font-size: 0.8em; margin-top: 5px; cursor: pointer;">
                Learn More
              </button>
            </div>
          `;
        }, 2000);
      }
    }
  };

  // ==================== SCHOOL MAIN APPLICATION ====================
  (function() {
    console.log('Starting School Spelling Practice...');
    
    // UI Elements
    const elements = {
      answer: document.getElementById('answer'),
      submit: document.getElementById('btnSubmit'),
      start: document.getElementById('btnStart'),
      say: document.getElementById('btnSayAgain'),
      flag: document.getElementById('btnFlag'),
      end: document.getElementById('btnEnd'),
      progress: document.getElementById('progress'),
      feedback: document.getElementById('feedback'),
      summaryArea: document.querySelector('.summary-area'),
      customBox: document.getElementById('customWords'),
      useCustom: document.getElementById('useCustomList')
    };
    
    // Default school word list (grade 3-5 level)
    const SCHOOL_WORDS = [
      'about', 'above', 'across', 'after', 'again', 'against', 'almost', 'alone',
      'along', 'already', 'also', 'although', 'always', 'among', 'another', 'answer',
      'appear', 'around', 'arrive', 'article', 'because', 'become', 'before', 'begin',
      'behind', 'believe', 'below', 'between', 'beyond', 'brother', 'building', 'business',
      'capital', 'century', 'certain', 'children', 'circle', 'city', 'class', 'clear',
      'color', 'common', 'complete', 'consider', 'contain', 'country', 'course', 'cover',
      'create', 'current', 'decide', 'describe', 'develop', 'different', 'difficult',
      'direct', 'discover', 'distance', 'divide', 'during', 'early', 'earth', 'east',
      'effect', 'eight', 'either', 'element', 'energy', 'enough', 'enter', 'entire',
      'equal', 'especially', 'evening', 'event', 'every', 'example', 'except', 'exercise',
      'expect', 'experience', 'experiment', 'explain', 'express', 'family', 'father',
      'figure', 'final', 'follow', 'forest', 'forget', 'form', 'forward', 'friend',
      'garden', 'general', 'government', 'great', 'ground', 'group', 'grow', 'happen',
      'heavy', 'height', 'history', 'however', 'hundred', 'idea', 'important', 'improve',
      'include', 'increase', 'inside', 'instead', 'interest', 'invent', 'island', 'just',
      'knowledge', 'language', 'large', 'later', 'learn', 'length', 'letter', 'level',
      'light', 'listen', 'little', 'machine', 'material', 'matter', 'maybe', 'measure',
      'member', 'method', 'middle', 'minute', 'moment', 'mother', 'mountain', 'music',
      'nation', 'natural', 'necessary', 'never', 'notice', 'number', 'object', 'observe',
      'ocean', 'often', 'order', 'original', 'other', 'outside', 'paper', 'paragraph',
      'parent', 'particular', 'pattern', 'people', 'perhaps', 'period', 'person',
      'picture', 'piece', 'place', 'planet', 'plant', 'point', 'possible', 'pound',
      'power', 'practice', 'prepare', 'present', 'president', 'problem', 'process',
      'produce', 'product', 'program', 'project', 'property', 'protect', 'prove',
      'provide', 'question', 'quick', 'quiet', 'quite', 'radio', 'raise', 'reach',
      'ready', 'reason', 'receive', 'record', 'region', 'remember', 'repeat', 'report',
      'represent', 'require', 'result', 'return', 'right', 'river', 'round', 'science',
      'second', 'section', 'segment', 'separate', 'serve', 'several', 'shape', 'should',
      'similar', 'simple', 'since', 'single', 'sister', 'situation', 'social', 'society',
      'solve', 'sound', 'source', 'south', 'space', 'special', 'specific', 'speech',
      'spell', 'spring', 'square', 'standard', 'station', 'still', 'stone', 'story',
      'straight', 'strange', 'street', 'strong', 'structure', 'student', 'study',
      'subject', 'success', 'sudden', 'suggest', 'summer', 'supply', 'support', 'sure',
      'surface', 'surprise', 'system', 'table', 'teacher', 'technology', 'television',
      'temperature', 'therefore', 'thing', 'thought', 'through', 'together', 'tonight',
      'total', 'toward', 'travel', 'trouble', 'true', 'under', 'understand', 'unit',
      'until', 'usually', 'value', 'various', 'village', 'visit', 'voice', 'wait',
      'watch', 'water', 'weather', 'weight', 'welcome', 'west', 'whether', 'while',
      'whole', 'window', 'winter', 'within', 'without', 'woman', 'wonder', 'world',
      'write', 'wrong', 'young'
    ];
    
    // App State
    const state = {
      words: [],
      currentIndex: 0,
      correct: [],
      incorrect: [],
      flags: new Set(),
      isActive: false,
      history: []
    };
    
    // Update progress display
    function updateProgress() {
      if (elements.progress) {
        elements.progress.textContent = `Word ${state.currentIndex + 1} of ${state.words.length}`;
      }
    }
    
    // Update feedback
    function updateFeedback(message, isError = false) {
      if (elements.feedback) {
        elements.feedback.textContent = message;
        elements.feedback.style.color = isError ? '#f72585' : '#ffffff';
      }
      console.log(message);
    }
    
    // Speak word
    function speakWord(word) {
      if (!window.speechSynthesis) {
        updateFeedback('Speech synthesis not supported', true);
        return;
      }
      
      try {
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.rate = 0.9; // Slightly faster for school
        utterance.pitch = 1;
        utterance.volume = 1;
        utterance.lang = 'en-US';
        
        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
          const voice = voices.find(v => v.lang.includes('en')) || voices[0];
          utterance.voice = voice;
        }
        
        utterance.onend = () => {
          console.log('Finished speaking:', word);
        };
        
        utterance.onerror = (e) => {
          console.error('Speech error:', e);
          updateFeedback('Error speaking word', true);
        };
        
        speechSynthesis.speak(utterance);
        updateFeedback(`Word spoken: "${word}"`);
        
      } catch (error) {
        console.error('Speech error:', error);
        updateFeedback('Could not speak word', true);
      }
    }
    
    // Speak current word
    function speakCurrentWord() {
      if (!state.isActive || state.currentIndex >= state.words.length) return;
      const word = state.words[state.currentIndex];
      if (word) {
        speakWord(word);
      }
    }
    
    // Check answer
    function checkAnswer() {
      if (!state.isActive) {
        updateFeedback('Start a session first', true);
        return;
      }
      
      const word = state.words[state.currentIndex];
      const answer = elements.answer ? elements.answer.value.trim() : '';
      
      if (!answer) {
        updateFeedback('Please type what you heard', true);
        return;
      }
      
      const normalizedWord = word.toLowerCase().trim();
      const normalizedAnswer = answer.toLowerCase().trim();
      
      if (normalizedAnswer === normalizedWord) {
        state.correct.push(word);
        updateFeedback(`‚úÖ Correct! "${word}" is spelled correctly.`);
      } else {
        state.incorrect.push({ 
          word: word, 
          answer: answer,
          yourSpelling: answer,
          correctSpelling: word
        });
        updateFeedback(`‚ùå Incorrect. You wrote "${answer}", correct is "${word}"`);
      }
      
      // Auto-clear and advance
      if (elements.answer) elements.answer.value = '';
      
      state.currentIndex++;
      
      if (state.currentIndex < state.words.length) {
        updateProgress();
        setTimeout(() => {
          speakCurrentWord();
        }, 1000);
      } else {
        setTimeout(endSession, 1500);
      }
      
      saveProgress();
    }
    
    // Start session
    function startSession() {
      const customText = elements.customBox ? elements.customBox.value.trim() : '';
      
      if (customText) {
        const words = customText.split(/[\n,]+/).map(w => w.trim()).filter(w => w);
        const limitedWords = words.slice(0, 30); // School freemium limit
        state.words = limitedWords;
        if (words.length > 30) {
          updateFeedback(`School Freemium: Using first 30 of ${words.length} words`);
        } else {
          updateFeedback(`Using custom list: ${words.length} words`);
        }
      } else {
        const shuffled = [...SCHOOL_WORDS].sort(() => Math.random() - 0.5);
        state.words = shuffled.slice(0, 50); // School freemium limit
        updateFeedback(`Practice mode: ${state.words.length} school words (freemium limit)`);
      }
      
      if (state.words.length === 0) {
        updateFeedback('No words available', true);
        return;
      }
      
      state.currentIndex = 0;
      state.correct = [];
      state.incorrect = [];
      state.flags.clear();
      state.history = [];
      state.isActive = true;
      
      if (elements.summaryArea) {
        elements.summaryArea.style.display = 'none';
        elements.summaryArea.classList.add('hidden');
      }
      
      updateProgress();
      updateFeedback('Session started! Listen carefully...');
      
      setTimeout(() => {
        speakCurrentWord();
      }, 1000);
      
      saveProgress();
    }
    
    // End session and show summary
    function endSession() {
      state.isActive = false;
      speechSynthesis.cancel();
      
      const total = state.words.length;
      const correctCount = state.correct.length;
      const incorrectWords = state.incorrect;
      const flaggedWords = Array.from(state.flags);
      
      let summaryHTML = `
        <div style="background: rgba(0,0,0,0.1); padding: 20px; border-radius: 10px;">
          <h3 style="margin-top: 0; color: #7b2ff7;">Great Job! üéì</h3>
          <p style="font-size: 1.2em; font-weight: bold; color: #7b2ff7;">
            Score: ${correctCount}/${total} correct (${Math.round((correctCount/total)*100)}%)
          </p>
      `;
      
      if (state.incorrect.length > 0) {
        summaryHTML += `
          <div style="margin: 20px 0;">
            <h4 style="color: #f72585;">Words to Review (${state.incorrect.length})</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
        `;
        
        state.incorrect.forEach(item => {
          summaryHTML += `
            <div style="background: rgba(247, 37, 133, 0.1); padding: 10px; border-radius: 5px;">
              <strong style="color: #f72585;">${item.correctSpelling}</strong><br>
              <small>You wrote: <span style="color: #666;">"${item.yourSpelling}"</span></small>
            </div>
          `;
        });
        
        summaryHTML += `</div></div>`;
      }
      
      if (flaggedWords.length > 0) {
        summaryHTML += `
          <div style="margin: 20px 0;">
            <h4 style="color: #ffd166;">Flagged Words (${flaggedWords.length})</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
        `;
        
        flaggedWords.forEach(word => {
          summaryHTML += `
            <div style="background: rgba(255, 209, 102, 0.1); padding: 10px; border-radius: 5px;">
              ${word}
            </div>
          `;
        });
        
        summaryHTML += `</div></div>`;
      }
      
      summaryHTML += `
        <div style="margin: 20px 0; padding: 15px; background: rgba(123, 47, 247, 0.1); border-radius: 8px;">
          <h4 style="color: #7b2ff7;">Practice More</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      `;
      
      if (state.incorrect.length > 0) {
        summaryHTML += `
          <button onclick="practiceIncorrect()" class="btn-secondary" style="background: #f72585;">
            <i class="fa fa-redo"></i> Review Missed (${state.incorrect.length})
          </button>
        `;
      }
      
      if (flaggedWords.length > 0) {
        summaryHTML += `
          <button onclick="practiceFlagged()" class="btn-secondary" style="background: #ffd166; color: #333;">
            <i class="fa fa-flag"></i> Practice Flagged (${flaggedWords.length})
          </button>
        `;
      }
      
      summaryHTML += `
            <button onclick="restartSession()" class="btn-primary">
              <i class="fa fa-play-circle"></i> New Session
            </button>
          </div>
        </div>
      `;
      
      // Add school premium upgrade prompt
      summaryHTML += `
        <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #7b2ff7, #f72585); border-radius: 10px; color: white;">
          <h4 style="margin: 0 0 10px 0;">üè´ Unlock School Premium!</h4>
          <p style="margin: 0 0 15px 0; font-size: 0.9em;">
            Perfect for students and teachers:<br>
            ‚Ä¢ Unlimited word lists<br>
            ‚Ä¢ Create and save custom lists<br>
            ‚Ä¢ Track student progress<br>
            ‚Ä¢ Export results<br>
            ‚Ä¢ No ads
          </p>
          <button onclick="window.location.href='/premium.html'" 
            style="background: white; color: #7b2ff7; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">
            <i class="fa fa-crown"></i> Get School Premium
          </button>
        </div>
      `;
      
      summaryHTML += `</div>`;
      
      if (elements.summaryArea) {
        elements.summaryArea.innerHTML = summaryHTML;
        elements.summaryArea.style.display = 'block';
        elements.summaryArea.classList.remove('hidden');
      }
      
      updateFeedback('Session completed! Check your results below.');
      localStorage.removeItem('school_progress');
    }
    
    // Save progress to localStorage
    function saveProgress() {
      const progress = {
        words: state.words,
        currentIndex: state.currentIndex,
        correct: state.correct,
        incorrect: state.incorrect,
        flags: Array.from(state.flags),
        timestamp: Date.now()
      };
      localStorage.setItem('school_progress', JSON.stringify(progress));
    }
    
    // Load progress from localStorage
    function loadProgress() {
      try {
        const saved = localStorage.getItem('school_progress');
        if (!saved) return false;
        
        const progress = JSON.parse(saved);
        const hoursOld = (Date.now() - progress.timestamp) / (1000 * 60 * 60);
        
        if (hoursOld > 24) {
          localStorage.removeItem('school_progress');
          return false;
        }
        
        state.words = progress.words || [];
        state.currentIndex = progress.currentIndex || 0;
        state.correct = progress.correct || [];
        state.incorrect = progress.incorrect || [];
        state.flags = new Set(progress.flags || []);
        
        if (state.words.length > 0 && state.currentIndex < state.words.length) {
          const resume = confirm(`You have an incomplete session.\nResume from word ${state.currentIndex + 1} of ${state.words.length}?`);
          if (resume) {
            state.isActive = true;
            updateProgress();
            speakCurrentWord();
            updateFeedback(`Resumed from word ${state.currentIndex + 1}`);
            return true;
          }
        }
      } catch (error) {
        console.error('Error loading progress:', error);
      }
      return false;
    }
    
    // Practice only incorrect words
    function practiceIncorrect() {
      const incorrectWords = state.incorrect.map(item => item.correctSpelling);
      if (incorrectWords.length === 0) {
        updateFeedback('No missed words to practice', true);
        return;
      }
      
      state.words = [...new Set(incorrectWords)];
      state.currentIndex = 0;
      state.correct = [];
      state.incorrect = [];
      state.flags.clear();
      state.isActive = true;
      
      if (elements.summaryArea) {
        elements.summaryArea.style.display = 'none';
        elements.summaryArea.classList.add('hidden');
      }
      
      updateProgress();
      updateFeedback(`Practicing ${state.words.length} missed words`);
      
      setTimeout(() => {
        speakCurrentWord();
      }, 1000);
    }
    
    // Practice only flagged words
    function practiceFlagged() {
      const flaggedWords = Array.from(state.flags);
      if (flaggedWords.length === 0) {
        updateFeedback('No flagged words to practice', true);
        return;
      }
      
      state.words = flaggedWords;
      state.currentIndex = 0;
      state.correct = [];
      state.incorrect = [];
      state.flags.clear();
      state.isActive = true;
      
      if (elements.summaryArea) {
        elements.summaryArea.style.display = 'none';
        elements.summaryArea.classList.add('hidden');
      }
      
      updateProgress();
      updateFeedback(`Practicing ${flaggedWords.length} flagged words`);
      
      setTimeout(() => {
        speakCurrentWord();
      }, 1000);
    }
    
    // Restart session
    function restartSession() {
      if (elements.summaryArea) {
        elements.summaryArea.style.display = 'none';
        elements.summaryArea.classList.add('hidden');
      }
      
      if (elements.answer) {
        elements.answer.value = '';
      }
      
      updateFeedback('Ready to start new session');
      updateProgress();
      
      localStorage.removeItem('school_progress');
    }
    
    // Toggle flag for current word
    function toggleFlag() {
      if (!state.isActive || state.currentIndex >= state.words.length) {
        updateFeedback('No active word to flag', true);
        return;
      }
      
      const word = state.words[state.currentIndex];
      if (state.flags.has(word)) {
        state.flags.delete(word);
        updateFeedback(`üö© Removed flag from "${word}"`);
      } else {
        state.flags.add(word);
        updateFeedback(`üö© Flagged "${word}" for review`);
      }
      
      saveProgress();
    }
    
    // Set up event listeners
    function setupEventListeners() {
      if (elements.start) elements.start.addEventListener('click', startSession);
      if (elements.submit) elements.submit.addEventListener('click', checkAnswer);
      if (elements.say) elements.say.addEventListener('click', speakCurrentWord);
      if (elements.flag) elements.flag.addEventListener('click', toggleFlag);
      if (elements.end) elements.end.addEventListener('click', endSession);
      
      if (elements.answer) {
        elements.answer.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            checkAnswer();
          }
        });
      }
      
      if (elements.useCustom) {
        elements.useCustom.addEventListener('click', () => {
          const customText = elements.customBox ? elements.customBox.value.trim() : '';
          if (!customText) {
            updateFeedback('Please enter words in the custom box first', true);
            return;
          }
          const words = customText.split(/[\n,]+/).map(w => w.trim()).filter(w => w);
          state.words = words.slice(0, 30); // School freemium limit
          updateFeedback(`Custom list loaded: ${Math.min(words.length, 30)} words (school freemium limit)`);
        });
      }
      
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            document.getElementById('fileName').textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
              if (elements.customBox) {
                elements.customBox.value = e.target.result;
                updateFeedback(`File loaded: ${file.name}`);
              }
            };
            reader.readAsText(file);
          }
        });
      }
    }
    
    // Initialize the app
    function initialize() {
      console.log('Initializing School Spelling Practice...');
      
      setupEventListeners();
      loadProgress();
      
      // Initialize dark mode toggle
      const darkModeToggle = document.getElementById('toggleDark');
      if (darkModeToggle) {
        darkModeToggle.addEventListener('click', () => {
          document.body.classList.toggle('dark-mode');
          const icon = darkModeToggle.querySelector('i');
          if (icon) {
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
          }
          localStorage.setItem('dark', document.body.classList.contains('dark-mode'));
        });
        
        const savedDarkMode = localStorage.getItem('dark') === 'true';
        if (savedDarkMode) {
          document.body.classList.add('dark-mode');
          const icon = darkModeToggle.querySelector('i');
          if (icon) icon.className = 'fa fa-sun';
        }
      }
      
      // Expose functions globally
      window.practiceIncorrect = practiceIncorrect;
      window.practiceFlagged = practiceFlagged;
      window.restartSession = restartSession;
      
      // Initialize tier manager
      if (window.tierManager) {
        window.tierManager.init();
      }
      
      // Show cookie banner after delay
      setTimeout(() => {
        showCookieBanner();
      }, 1500);
      
      updateFeedback('Ready! Click "Start" to begin your school spelling practice.');
      console.log('‚úÖ School Spelling Practice initialized successfully');
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
    
  })();
  </script>

  <!-- File input handler -->
  <script>
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('fileName').textContent = file.name;
      }
    });
  </script>

  <script>
  // Performance monitoring
  window.addEventListener('load', function() {
    // Measure page load time
    const timing = window.performance.timing;
    const loadTime = timing.loadEventEnd - timing.navigationStart;
    
    // Log to console
    console.log(`Page loaded in ${loadTime}ms`);
    
    // Send to analytics if load time is slow
    if (loadTime > 3000 && typeof gtag !== 'undefined') {
      gtag('event', 'slow_load_time', {
        load_time: loadTime,
        page_path: window.location.pathname
      });
    }
    
    // Monitor premium feature usage
    if (window.tierManager) {
      console.log('Tier manager active:', window.tierManager);
    }
    
    // Track page view
    if (typeof gtag !== 'undefined') {
      gtag('event', 'page_view', {
        page_title: document.title,
        page_path: window.location.pathname
      });
    }
  });
  
  // Monitor errors
  window.addEventListener('error', function(e) {
    console.error('Page error:', e.error);
    
    // Send to error tracking service
    if (typeof gtag !== 'undefined') {
      gtag('event', 'exception', {
        description: e.error.message,
        fatal: false
      });
    }
  });
</script>

  <!-- Legal Footer -->
<footer style="text-align: center; margin-top: 40px; padding: 20px; color: #666; border-top: 1px solid rgba(255,255,255,0.1);">
  <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; flex-wrap: wrap;">
    <div style="text-align: center;">
      <i class="fa fa-lock" style="color: #7b2ff7; font-size: 1.5em;"></i>
      <div style="font-size: 0.8em;">SSL Secure</div>
    </div>
    <div style="text-align: center;">
      <i class="fa fa-shield-alt" style="color: #7b2ff7; font-size: 1.5em;"></i>
      <div style="font-size: 0.8em;">14-Day Refund</div>
    </div>
    <div style="text-align: center;">
      <i class="fa fa-user-shield" style="color: #7b2ff7; font-size: 1.5em;"></i>
      <div style="font-size: 0.8em;">GDPR Compliant</div>
    </div>
  </div>
  
  <p>
    <a href="/privacy.html" style="color: #7b2ff7; text-decoration: none;">Privacy Policy</a> 
    ‚Ä¢ 
    <a href="/terms.html" style="color: #7b2ff7; text-decoration: none;">Terms of Service</a>
    ‚Ä¢ 
    <a href="/refund-policy.html" style="color: #7b2ff7; text-decoration: none;">Refund Policy</a>
    ‚Ä¢ 
    <a href="/security.html" style="color: #7b2ff7; text-decoration: none;">Security</a>
    ‚Ä¢ 
    <a href="/contact.html" style="color: #7b2ff7; text-decoration: none;">Contact</a>
  </p>
  <p style="margin-top: 10px; font-size: 0.9em;">&copy; 2026 SpellRightPro. All rights reserved.</p>
</footer>
</body>
</html>
