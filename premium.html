<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SpellRightPro Premium</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Preconnects -->
  <link rel="preconnect" href="https://js.stripe.com" />
  <link rel="preconnect" href="https://www.gstatic.com" />
  <link rel="preconnect" href="https://www.googleapis.com" />

  <!-- Firebase compat (NO defer) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-analytics-compat.js"></script>

  <!-- Config (NO defer) -->
  <script src="/js/config.js?v=2025-08-29"></script>

  <!-- Initialize Firebase immediately (NO defer) -->
  <script>
    (function () {
      const cfg = window.appConfig && window.appConfig.firebaseConfig;
      if (!cfg) { console.error('firebaseConfig missing from config.js'); return; }
      if (!firebase.apps.length) {
        firebase.initializeApp(cfg);
        try { firebase.analytics(); } catch(_) {}
      }
    })();
  </script>

  <!-- Styles -->
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/premium.css">
  <link rel="icon" href="/assets/logo.png">

  <!-- Stripe (defer) -->
  <script src="https://js.stripe.com/v3/" defer></script>

  <!-- Helpers / data (defer) -->
  <script src="/js/common.js?v=2025-08-29" defer></script>
  <script src="/js/oet_word_list.js?v=2025-08-29" defer></script>

  <!-- Main premium app (defer) -->
  <script src="/js/main-premium.js?v=2025-08-29" defer></script>
</head>
<body>
  <!-- header/navbar ... -->

  <main class="container">
    <!-- auth area + premium app -->
    <div id="auth-area"></div>
    <section id="premium-app" class="training-card hidden">
      <h2 id="app-title">Premium</h2>
      <div id="exam-ui"></div>
      <div id="trainer-area" class="hidden"></div>
      <div id="summary-area" class="hidden"></div>
    </section>
  </main>

  <!-- Conditional Google Auto Ads (hide for Premium users) -->
  <script>
    // Simple readiness helper
    function waitForFirebaseAppReady(timeoutMs = 3000) {
      return new Promise(res => {
        const start = Date.now();
        (function tick(){
          if (window.firebase && firebase.apps.length) return res(true);
          if (Date.now() - start > timeoutMs) return res(false);
          setTimeout(tick, 50);
        })();
      });
    }

    function injectAutoAdsScript() {
      const client = (window.appConfig && window.appConfig.adClient) || 'ca-pub-7632930282249669';
      if (document.getElementById('auto-ads-script')) return;
      const s = document.createElement('script');
      s.id = 'auto-ads-script';
      s.async = true;
      s.crossOrigin = 'anonymous';
      s.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=' + client;
      document.head.appendChild(s);
    }

    (async function initConditionalAds() {
      const ready = await waitForFirebaseAppReady();
      if (!ready) { injectAutoAdsScript(); return; }

      try {
        // Ensure app is initialized with the same key used everywhere else
        if (!firebase.apps.length && window.appConfig?.firebaseConfig) {
          firebase.initializeApp(window.appConfig.firebaseConfig);
        }

        const user = firebase.auth().currentUser;
        if (!user) { injectAutoAdsScript(); return; }

        const uid = user.uid;
        // Read premium flag OR active subscription (rules must allow read)
        const userDoc = await firebase.firestore().collection('users').doc(uid).get();
        const isPremiumFlag = !!(userDoc.exists && userDoc.data()?.isPremium);

        let hasSub = false;
        try {
          const subSnap = await firebase.firestore()
            .collection('customers').doc(uid)
            .collection('subscriptions')
            .where('status', 'in', ['active','trialing'])
            .limit(1).get();
          hasSub = !subSnap.empty;
        } catch(_) {}

        if (!(isPremiumFlag || hasSub)) {
          injectAutoAdsScript(); // non-premium → load auto ads
        } else {
          // premium → hide any ad containers just in case
          const st = document.createElement('style');
          st.textContent = '.google-auto-placed, ins.adsbygoogle, .ad-container{display:none!important}';
          document.head.appendChild(st);
        }
      } catch (e) {
        console.warn('[Premium] Stripe check failed:', e);
        injectAutoAdsScript(); // fail open to ads for non-premium
      }
    })();
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(console.warn);
    }
  </script>
</body>
</html>
